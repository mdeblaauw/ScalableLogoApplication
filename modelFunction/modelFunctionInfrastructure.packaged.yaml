Resources:
  PreparationBucket:
    Type: AWS::S3::Bucket
    Properties: {}
  ImageBucket:
    Type: AWS::S3::Bucket
    Properties: {}
  OutputDatabase:
    Type: AWS::DynamoDB::Table
    Properties:
      AttributeDefinitions:
      - AttributeName: ImageId
        AttributeType: S
      - AttributeName: Timestamp
        AttributeType: N
      KeySchema:
      - AttributeName: ImageId
        KeyType: HASH
      - AttributeName: Timestamp
        KeyType: RANGE
      ProvisionedThroughput:
        ReadCapacityUnits: 2
        WriteCapacityUnits: 2
  PytorchLambdaLayer:
    Type: AWS::Lambda::LayerVersion
    Properties:
      CompatibleRuntimes:
      - python3.6
      Content:
        S3Bucket: logoapplication-lambdafiles-34fl9as0
        S3Key: a0c79649eb07d80d375b9622c45887df
  ModelFunctionLambdaRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
        - Effect: Allow
          Principal:
            Service: lambda.amazonaws.com
          Action: sts:AssumeRole
      Policies:
      - PolicyName: lambdaModelFunction
        PolicyDocument:
          Version: 2012-10-17
          Statement:
          - Effect: Allow
            Action:
            - logs:CreateLogGroup
            - logs:CreateLogStream
            - logs:PutLogEvents
            Resource: '*'
          - Effect: Allow
            Action:
            - s3:GetObject
            - s3:ListBucket
            Resource:
            - Fn::Sub: ${PreparationBucket.Arn}/*
            - Fn::Sub: ${ImageBucket.Arn}/*
          - Effect: Allow
            Action: dynamodb:PutItem
            Resource:
              Fn::GetAtt:
              - OutputDatabase
              - Arn
  ModelFunctionLambda:
    Type: AWS::Lambda::Function
    Properties:
      Code:
        S3Bucket: logoapplication-lambdafiles-34fl9as0
        S3Key: 363a2f296e3210ff2e59a83b1b44d8de
      FunctionName: logoApplicationModelFunction
      Handler: lambda_function.lambda_handler
      Role:
        Fn::GetAtt:
        - ModelFunctionLambdaRole
        - Arn
      Runtime: python3.6
      Layers:
      - Ref: PytorchLambdaLayer
      Environment:
        Variables:
          TableName:
            Ref: OutputDatabase
          image_bucket:
            Ref: ImageBucket
          preparation_bucket:
            Ref: PreparationBucket
